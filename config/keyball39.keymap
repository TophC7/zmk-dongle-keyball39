#define DEFAULT 0
#define ALT     1
#define SYS     2
#define MOD     3
#define MOUSE   4
#define SCROLL  5
#define SNIPE   6
#define PLAIN   7

#include <behaviors/mouse_keys.dtsi>
#include <dt-bindings/zmk/mouse.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/ext_power.h>

&nice_view_spi { cs-gpios = <&pro_micro 1 GPIO_ACTIVE_HIGH>; };

&lt {
    tapping-term-ms = <150>;
    flavor = "balanced";
    quick-tap-ms = <150>;
};

&mt {
    tapping-term-ms = <150>;
    flavor = "tap-preferred";
    quick-tap-ms = <150>;
};

&caps_word { continue-list = <UNDERSCORE MINUS>; };

/ {
    behaviors {
        // Tap dances for shift keys - shift, alt, compose
        td_shift: tap_dance_shift {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_SHIFT";
            #binding-cells = <0>;
            tapping-term-ms = <200>;
            bindings = <&kp LSHFT>, <&mo ALT>, <&kp K_APP>;
        };

        // PLAIN layer X key - x, esc, toggle out of layer
        td_plain_x: tap_dance_plain_x {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_PLAIN_X";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp X>, <&kp ESC>, <&tog PLAIN>;
        };

        // Number row tap dances - letter on tap, number on double tap
        td_q: tap_dance_q {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_Q";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp Q>, <&kp N1>;
        };

        td_w: tap_dance_w {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_W";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp W>, <&kp N2>;
        };

        td_f: tap_dance_f {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_F";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp F>, <&kp N3>;
        };

        td_p: tap_dance_p {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_P";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp P>, <&kp N4>;
        };

        td_g: tap_dance_g {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_G";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp G>, <&kp N5>;
        };

        td_j: tap_dance_j {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_J";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp J>, <&kp N6>;
        };

        td_l: tap_dance_l {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_L";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp L>, <&kp N7>;
        };

        td_u: tap_dance_u {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_U";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp U>, <&kp N8>;
        };

        td_y: tap_dance_y {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_Y";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp Y>, <&kp N9>;
        };

        td_o: tap_dance_o {
            compatible = "zmk,behavior-tap-dance";
            label = "TAP_DANCE_O";
            #binding-cells = <0>;
            tapping-term-ms = <150>;
            bindings = <&kp O>, <&kp N0>;
        };
    };

    macros {
        // Layer-mod macro: activates layer + sends modifier while held
        lm: lm {
            compatible = "zmk,behavior-macro-two-param";
            wait-ms = <0>;
            tap-ms = <0>;
            #binding-cells = <2>;
            bindings
                = <&macro_param_1to1>
                , <&macro_press &mo MACRO_PLACEHOLDER>
                , <&macro_param_2to1>
                , <&macro_press &kp MACRO_PLACEHOLDER>
                , <&macro_pause_for_release>
                , <&macro_param_2to1>
                , <&macro_release &kp MACRO_PLACEHOLDER>
                , <&macro_param_1to1>
                , <&macro_release &mo MACRO_PLACEHOLDER>
                ;
        };

        macro_l: macro_l {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            wait-ms = <10>;
            tap-ms = <10>;
            bindings = <&kp N9 &kp LS(H) &kp N2 &kp I &kp LS(U) &kp AMPS &kp N3 &kp B &kp LS(S) &kp LS(T) &kp LS(J) &kp LS(H) &kp N3 &kp LS(P)>;
            label = "MACRO_L";
        };

        macro_u: macro_u {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            wait-ms = <10>;
            tap-ms = <10>;
            bindings = <&kp T &kp O &kp O &kp R &kp N4 &kp N0 &kp N4>;
            label = "MACRO_U";
        };

        caf: ctrl_alt_layer {
            compatible = "zmk,behavior-macro-one-param";
            #binding-cells = <1>;
            bindings
                = <&macro_param_1to1>
                , <&macro_press &mo MACRO_PLACEHOLDER>
                , <&macro_press &kp LCTRL>
                , <&macro_press &kp LALT>
                , <&macro_pause_for_release>
                , <&macro_release &kp LALT>
                , <&macro_release &kp LCTRL>
                , <&macro_param_1to1>
                , <&macro_release &mo MACRO_PLACEHOLDER>
                ;
            label = "CTRL_ALT_LAYER";
        };
    };

    keymap {
        compatible = "zmk,keymap";

        default_layer {
            label = "COLEMAK";
            bindings = <
&td_q         &td_w &td_f &td_p &td_g                            &td_j     &td_l         &td_u     &td_y    &kp BSPC
&kp A         &kp R &kp S &kp T &kp D                            &kp H     &kp N         &kp E     &kp I    &td_o
&kp Z         &kp X &kp C &kp V &kp B                            &kp K     &kp M         &kp COMMA &kp DOT  &kp SQT
&mt LCTRL ESC                   &td_shift &lm MOD LALT &kp SPACE &td_shift &lt SYS ENTER &kp TAB   &kp FSLH &kp SEMI
            >;
        };

        alt_layer {
            label = "ALT";
            bindings = <
&kp EXCL  &kp AT &kp HASH &kp DLLR  &kp PRCNT               &kp CARET &kp AMPS &kp STAR &trans   &kp DEL
&kp GRAVE &trans &trans   &kp EQUAL &kp PLUS                &kp LPAR  &kp RPAR &trans   &trans   &trans
&kp TILDE &trans &trans   &kp UNDER &kp MINUS               &kp LBKT  &kp RBKT &kp LBRC &kp RBRC &trans
&trans                              &trans    &trans &trans &trans    &trans   &trans   &kp BSLH &kp PIPE
            >;
        };

        sys_layer {
            label = "SYS";
            bindings = <
&kp F1  &kp F2  &kp F3  &kp F4  &kp F5                  &kp C_BRI_UP &kp C_VOL_UP &kp HOME   &kp PSCRN &kp PG_UP
&kp F6  &kp F7  &kp F8  &kp F9  &kp F10                 &kp C_BRI_DN &kp C_VOL_DN &kp END    &kp UP    &kp PG_DN
&kp F11 &kp F12 &kp F13 &kp F14 &kp DEL                 &trans       &kp C_MUTE   &kp LEFT   &kp DOWN  &kp RIGHT
&caf SYS                        &trans  &trans &macro_l &macro_u     &trans       &kp C_PREV &kp C_PP  &kp C_NEXT
            >;
        };

        mod_layer {
            label = "MOD";
            bindings = <
&kp Q  &kp W  &kp F  &kp P  &kp G                  &kp J  &kp L  &kp U  &kp Y  &trans
&trans &trans &trans &trans &trans                 &trans &trans &trans &trans &kp O
&trans &trans &trans &trans &trans                 &trans &trans &trans &trans &trans
&trans                      &kp LGUI &trans &trans &trans &trans &trans &trans &trans
            >;
        };

        mouse_layer {
            label = "MOUSE";
            bindings = <
&trans &trans    &mkp MCLK  &trans    &trans               &trans &trans &trans &trans &trans
&trans &mkp LCLK &mo SCROLL &mkp RCLK &trans               &trans &trans &trans &trans &trans
&trans &trans    &mo SNIPE  &trans    &trans               &trans &trans &trans &trans &trans
&trans                                &trans &trans &trans &trans &trans &trans &trans &trans
            >;
        };

        scroll_layer {
            label = "SCROLL";
            bindings = <
&trans  &trans    &trans &trans    &trans                  &trans  &trans  &trans  &trans  &trans
&trans  &mkp LCLK &trans &mkp RCLK &trans                  &trans  &trans  &trans  &trans  &trans
&trans  &trans    &trans &trans    &trans                  &trans  &trans  &trans  &trans  &trans
&trans                             &trans  &trans  &trans  &trans  &trans  &trans  &trans  &trans
            >;
        };

        snipe_layer {
            label = "SNIPE";
            bindings = <
&to PLAIN &trans    &trans  &trans   &trans                  &trans  &trans  &trans  &trans  &trans
&trans    &mkp LCLK &trans &mkp RCLK &trans                  &trans  &trans  &trans  &trans  &trans
&trans    &trans    &trans  &trans   &trans                  &trans  &trans  &trans  &trans  &trans
&trans                               &trans  &trans  &trans  &trans  &trans  &trans  &trans  &trans
            >;
        };

        plain_layer {
            label = "PLAIN";
            bindings = <
&kp Q     &kp W       &kp F &kp P &kp G                        &kp J     &kp L      &kp U      &kp Y    &trans
&kp A     &kp R       &kp S &kp T &kp D                        &kp H     &kp N      &kp E      &kp I    &kp O
&kp Z     &td_plain_x &kp C &kp V &kp B                        &kp K     &kp M      &kp COMMA  &kp DOT  &kp SQT
&kp LCTRL                         &kp LSHFT &kp LALT &kp SPACE &kp LSHFT &kp ENTER  &kp TAB    &trans   &trans
            >;
        };
    };
};
